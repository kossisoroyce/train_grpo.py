version: '3.8'

services:
  grpo-trainer:
    build:
      context: .
      dockerfile: Dockerfile
    image: grpo-trainer:latest
    container_name: grpo-trainer
    
    # GPU support
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # Mount volumes
    volumes:
      - ./outputs:/app/outputs
      - ./configs:/app/configs
      - ./data:/app/data
      - ~/.cache/huggingface:/root/.cache/huggingface  # Cache HF models
    
    # Environment variables
    environment:
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - HF_TOKEN=${HF_TOKEN:-}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    
    # Keep container running
    stdin_open: true
    tty: true
    
    # Default command (override with docker-compose run)
    command: ["bash"]

  # Training service
  train:
    extends:
      service: grpo-trainer
    command: ["grpo-train", "-c", "/app/configs/default.yaml"]

  # Evaluation service
  evaluate:
    extends:
      service: grpo-trainer
    command: ["grpo-eval", "/app/outputs/grpo-default", "-d", "gsm8k", "-s", "test"]
